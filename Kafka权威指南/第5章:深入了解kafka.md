
# 第5章:深入了解kafka

1. 集群成员关系
   1. 集群通过zookeeper维护成员关系，每个broker都有一个唯一id，通过在zookeeper上注册临时节点实现服务发现
   2. 关闭broker时，他注册的节点也会消失，但是唯一id会保存起来，如果启动另一个相同id的broker，数据也会保留下来
2. 控制器
   1. 第一个启动的broker会在zookeeper中注册一个/controller临时节点，并负责分区leader的选举
   2. 其它的broker也会在zookeeper中注册控制节点，但是会收到节点存在异常后退出
   3. 当控制器断开时其它broker会监听到zookeeper事件并尝试注册控制节点，注册成功的broker会生成一个新的值更大的epoch消息，以使其它broker忽略之前epoch的控制器消息
   4. 失去leader的分区会重新分配leader，一般为分区列表中的下一个副本
   5. 控制器通过epoch避免脑裂
3. 复制
   1. 首领副本
      1. 为保证一致性，所有生产者消费者的请求都会通过首领副本
   2. 跟随者副本
      1. 跟随者副本不会处理客户端请求，只会从首领副本处复制消息
      2. 如果首领副本崩溃，将会从跟随者副本选举新的首领副本
   3. 跟随者同步数据是顺序的，没有完全同步数据的跟随者副本无法成为新的首领
   4. 首选首领
      1. 每个topic会有一个首选首领，首选首领是通过负载均衡后得到的，如果为同步状态会优先变成首领