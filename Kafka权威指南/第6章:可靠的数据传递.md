
# 第6章:可靠的数据传递

1. 可靠性保证
   1. ACID规范
      1. 原子性、一致性、隔离性、持久性
   2. kafka作出的保证
      1. 保证分区消息的顺序
      2. 消息被写入(不等于写入磁盘，只是写入系统写入缓冲区)到所有副本时，消息才被认为是"已提交的"
      3. 只要还有一个副本活跃，已经提交的消息就不会丢失
      4. 消费者只能读取已经提交的消息
2. 复制
   1. kafka的数据被分为多个分区，分区是基本的数据块，分区存储在单个磁盘上，单个分区内消息有序
   2. 每个分区可以有多个副本，其中一个为首领副本，所有读取、写入都通过首领副本完成
   3. 首领副本不可用时，从同步副本中选举一个首领
   4. 同步副本需要满足一下几个条件
      1. 与zookeeper有活跃的会话
      2. 最近一段时间(可配置)内从首领获取过消息
      3. 最近一段时间(可配置)内从首领获取过最新的消息
   5. 不恰当的垃圾回收配置会导致集群服务暂停，引起首领切换
3. broker配置
   1. 复制系数 replication.factor
      1. 如果复制系数为n，在n-1个broker失效时仍然可以读取或写入数据
      2. 如果复制系数为n，至少需要n个broker，存储空间也会是数据的n倍
      3. 一般建议设置为3就足够安全了
   2. 不完全的首领选举 unclean.leader.election
      1. 在选举过程中没有丢失数据，leader在同步副本中正常选举称为完全首领选举
      2. 设置为true就是允许不同步的副本成为首领，可能会丢失数据，可用性更高
   3. 最少同步副本 min.insync.replicas
      1. 当同步副本数量不足时，首领会拒绝新的写入消息，此时topic变为只读状态
