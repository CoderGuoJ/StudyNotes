# 第四章:Schema与数据类型优化

- 数据类型优化
  - 尽量选择最小的数据类型
  - 数据类型尽量简单(数值快于字符串,日期类型快于字符串)
  - 列尽量避免NULL
    - 优化困难(索引难以应用)
    - 空间占用大
    - 时间类型
      - timestamp 空间小,根据时区变化,自动更新,表示范围小
      - datetimte 空间占用大，稳定
- 整型
  - 存储范围(n代表位数)
    - $$ {-2}^{(n-1)} ～ {2}^{(n-1)}-1$$
  - 带不带符号占用空间相同，性能相同
  - 整数类型指定宽度 如: int(11)
    - 不会限制实际位数,只会影响显示
    - int(1) 与 int(20) 是相同的
  - 不同的整数类型定义
    - tinyint 8位
    - smallint 16位
    - mediumint 24位
    - int 32位
    - bigint 64位
- 实数类型
  - 不只是为了存放小数,也可以用decimal保存大于bigint的数
  - decimal
    - 用户存储精确小数
    - 指定精度后会影响列的存储空间大小
    - 使用二进制字符串存储
    - decimal(18,9)
      - 小数点俩边各保存9位数字
      - 每位数字占一字节,小数点占一字节
    - 最多允许65个数字
    - 计算时将转换为double类型,性能低于float和double直接计算
    - 采用bigint乘以10的n次方可以避免decimal带来的性能消耗
- 字符串类型
  - varchar与char (innodb)
    - 不同的存储引擎存储方式不同
    - varchar
      - 存储可变长字符串，最常见
      - 节省空间,性能更好 当row_format=fixed 时强制定长
      - 需要1到2个额外字节保存长度,大于255时使用2个字节
      - update时需要改变长度,造成额外性能消耗
      - 适合存储内容长度差距较大的值
      - varchar(1)与varchar(100)
        - 存储空间相同
        - 数字代表字符数
        - varchar(100)会占用更多的内存,带来性能消耗
    - char
      - 定长,会自动删除末尾的空格
      - 适合保存较短的，定长的值 例如md5值
      - 不容易产生碎片
      - 不保存长度可节省1个字节
  - blob与text
    - 每一个值都是一个独立对象
    - 值过大时数据库会存放指针,指向专用的外部存储
    - 尽量避免使用
    - 采用substring转换为短字符串进行操作
    - blob
      - 采用二进制方式存储
      - 没有排序规则或者字符集
    - text
      - 采用字符方式存储
      - 排序会根据max_sort_length长度进行,不会比较整个字符串
  - enum
    - 表结构中保存映射,值中保存数字
    - 按照映射数字排序
    - 根据映射查找字符串会产生额外开销
    - 与varchar或者char关联时很慢
  - 日期和时间
    - 最小粒度位秒
    - 支持微秒级临时计算
    - datetime
      - 1001年～9999年,精度为秒
      - 整数,8字节
      - 可排序、无歧义
    - timestamp
      - 从1970年1月1日(格林尼治标准时间)以来的秒数，同unix时间戳
      - 与时区有关
      - 4个字节，尽量使用
  - 位数据类型
    - bit
      - 在一个列中存储多个true/false值
      - 最大64位
      - 数字位原值，字符串位ascii码对应值
  - mysql schema 陷阱
    - 太多的列
      - 服务器层与存储引擎层通过行缓冲格式拷贝数据，然后在服务器层将行缓冲数据解码为各个列，代价很高
    - 关联表不超过12个
    - 枚举类型除了在最后追加内容以外，其他的alter table操作都会阻塞
    - 尽量避免null值
  - 范式
    - update更快
    - 只有很少或没有重复数据，只需要操作更少的数据
    - 表更小
    - 通常需要关联，影响性能
  - 反范式
    - 数据都在同一个表中，不需要关联
  - 额外的索引
    - 显著提升读性能
    - 降低写性能，增加开发难度
  - 加快 alter table
    - 主备切换或者影子拷贝
    - 直接修改.frm文件
    - 以下情况不会重建表
      - 移除一个列的自增长属性
      - 增加、移除或更改enum和set常量
